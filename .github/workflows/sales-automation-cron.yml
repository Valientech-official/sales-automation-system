name: Sales Automation Cron Job

on:
  schedule:
    # 5åˆ†é–“éš”ã§å®Ÿè¡Œ (UTCã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³) - GitHub Actionsæœ€å°é–“éš”
    - cron: '*/5 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  process-company:
    runs-on: ubuntu-latest
    
    steps:
    - name: Execute Sales Automation
      run: |
        echo "ğŸš€ å–¶æ¥­è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œé–‹å§‹: $(date)"
        
        # Vercelæœ¬ç•ªç’°å¢ƒã®APIã‚’å©ã
        response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
          "https://sales-automation-system.vercel.app/api/cron-process/")
        
        http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
        
        echo "ğŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code"
        echo "ğŸ“ ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $body"
        
        if [ $http_code -eq 200 ]; then
          echo "âœ… å‡¦ç†æˆåŠŸ!"
          
          # æˆåŠŸæ™‚ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’è§£æ
          echo "$body" | jq -r '
            if .success then
              "ğŸ¯ ä¼æ¥­: " + .result.companyName + 
              " (" + (.result.index + 1 | tostring) + "ä»¶ç›®)" +
              " | å‡¦ç†æ™‚é–“: " + (.result.executionTime / 1000 | floor | tostring) + "ç§’" +
              " | çµæœ: " + (if .result.scrapingSuccess then "æˆåŠŸ" else "å¤±æ•—: " + .result.error end)
            else
              "âŒ ã‚¨ãƒ©ãƒ¼: " + .error.message
            end'
        else
          echo "âŒ å‡¦ç†å¤±æ•—! HTTPã‚³ãƒ¼ãƒ‰: $http_code"
          echo "$body"
          exit 1
        fi
        
        echo "âœ¨ å–¶æ¥­è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œå®Œäº†: $(date)"